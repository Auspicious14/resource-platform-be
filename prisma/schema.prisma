// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

enum Role {
  STUDENT
  MENTOR
  ADMIN
  CONTRIBUTOR
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum DifficultyMode {
  GUIDED
  STANDARD
  HARDCORE
}

enum ProjectStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

model User {
  id              String         @id @default(uuid())
  email           String         @unique
  password        String?
  firstName       String
  lastName        String
  skillLevel      Difficulty     @default(BEGINNER)
  bio             String?
  portfolioLinks  String[]       @default([])
  xp              Int            @default(0)
  streak          Int            @default(0)
  role            Role           @default(STUDENT)
  avatarUrl       String?
  githubId        String?        @unique
  googleId        String?        @unique
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  projects        UserProject[]
  createdProjects Project[]      @relation("ProjectCreator")
  submissions     Submission[]
  comments        Comment[]
  votes           Vote[]
  forumThreads    ForumThread[]
  forumPosts      ForumPost[]
  chatMessages    ChatMessage[]
  
  teams           TeamMember[]
  achievements    UserAchievement[]
  pathProgress    UserPathProgress[]
  milestoneProgress UserMilestone[]
  
  followers       Follow[]         @relation("UserFollowing")
  following       Follow[]         @relation("UserFollowers")
  notifications   Notification[]
  eventParticipations EventParticipant[]
  eventLeaderboards   EventLeaderboard[]
  socialShares    SocialShare[]
  
  @@index([email])
  @@index([role])
}

model Project {
  id               String            @id @default(uuid())
  title            String
  slug             String            @unique
  description      String
  difficultyLevel  Difficulty
  technologies     String[]
  categories       String[]
  estimatedTime    String?
  learningObjectives String[]
  resourceLinks    Json[]            @default([])
  starterRepoUrl   String?
  difficultyModes  DifficultyMode[]  @default([GUIDED, STANDARD, HARDCORE])
  submissionCount  Int               @default(0)
  completionRate   Float             @default(0)
  featured         Boolean           @default(false)
  coverImage       String?
  
  createdById      String
  createdBy        User              @relation("ProjectCreator", fields: [createdById], references: [id], onDelete: Cascade)
  
  milestones       ProjectMilestone[]
  userProjects     UserProject[]
  submissions      Submission[]
  forumThreads     ForumThread[]
  chatMessages     ChatMessage[]
  
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  teams           Team[]
  learningPaths   LearningPathProject[]
  
  @@index([difficultyLevel])
  @@index([featured])
  @@index([slug])
  @@index([createdAt])
}

model UserProject {
  id                  String         @id @default(uuid())
  userId              String
  projectId           String
  status              ProjectStatus  @default(NOT_STARTED)
  difficultyModeChosen DifficultyMode
  repoUrl             String?
  startedAt           DateTime       @default(now())
  completedAt         DateTime?
  
  user                User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  project             Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  milestoneProgress   UserMilestone[]

  @@unique([userId, projectId, difficultyModeChosen])
  @@index([userId])
  @@index([projectId])
  @@index([status])
}

model ProjectMilestone {
  id                String   @id @default(uuid())
  projectId         String
  milestoneNumber   Int
  title             String
  description       String
  hints             Json     @default("{}")
  validationCriteria String?
  
  project           Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userProgress      UserMilestone[]

  @@unique([projectId, milestoneNumber])
  @@index([projectId])
}

model UserMilestone {
  id              String           @id @default(uuid())
  userId          String
  userProjectId   String?
  milestoneId     String
  completedAt     DateTime         @default(now())
  
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userProject     UserProject?     @relation(fields: [userProjectId], references: [id], onDelete: Cascade)
  milestone       ProjectMilestone @relation(fields: [milestoneId], references: [id], onDelete: Cascade)

  @@unique([userId, milestoneId, userProjectId])
  @@index([userId])
  @@index([milestoneId])
}

model Submission {
  id            String   @id @default(uuid())
  userId        String
  projectId     String
  repoUrl       String
  liveUrl       String?
  description   String?
  feedback      String?
  score         Int?
  upvotes       Int      @default(0)
  isPublic      Boolean  @default(false)
  aiReviewData  Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  comments    Comment[]
  votes       Vote[]
  
  @@index([userId])
  @@index([projectId])
  @@index([isPublic])
  @@index([createdAt])
}

model Comment {
  id            String     @id @default(uuid())
  content       String
  userId        String
  submissionId  String
  parentId      String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  submission    Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  parent        Comment?   @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies       Comment[]  @relation("CommentReplies")
  
  @@index([submissionId])
  @@index([userId])
  @@index([parentId])
}

model Vote {
  id            String     @id @default(uuid())
  value         Int        // 1 for upvote, -1 for downvote
  userId        String
  submissionId  String
  createdAt     DateTime   @default(now())
  
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  submission    Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@unique([userId, submissionId])
  @@index([submissionId])
}

model ForumThread {
  id            String     @id @default(uuid())
  title         String
  content       String
  userId        String
  projectId     String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  project       Project?   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  posts         ForumPost[]
  
  @@index([userId])
  @@index([projectId])
  @@index([createdAt])
}

model ForumPost {
  id            String     @id @default(uuid())
  content       String
  userId        String
  threadId      String
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  thread        ForumThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  
  @@index([threadId])
  @@index([userId])
}

model Team {
  id            String       @id @default(uuid())
  name          String
  projectId     String
  createdAt     DateTime     @default(now())
  
  project       Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  members       TeamMember[]
  
  @@index([projectId])
}

model TeamMember {
  id            String   @id @default(uuid())
  teamId        String
  userId        String
  joinedAt      DateTime @default(now())
  
  team          Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model Achievement {
  id          String   @id @default(uuid())
  name        String   @unique
  description String
  icon        String?
  xpReward    Int
  criteria    Json
  createdAt   DateTime @default(now())
  
  users       UserAchievement[]
}

model UserAchievement {
  id            String      @id @default(uuid())
  userId        String
  achievementId String
  earnedAt      DateTime    @default(now())
  
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
}

model LearningPath {
  id          String   @id @default(uuid())
  name        String
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  projects    LearningPathProject[]
  userProgress UserPathProgress[]
}

model LearningPathProject {
  id            String       @id @default(uuid())
  pathId        String
  projectId     String
  orderIndex    Int
  prerequisites String[]     @default([])
  
  path          LearningPath @relation(fields: [pathId], references: [id], onDelete: Cascade)
  project       Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([pathId, orderIndex])
  @@index([pathId])
  @@index([projectId])
}

model UserPathProgress {
  id                  String       @id @default(uuid())
  userId              String
  pathId              String
  currentProjectIndex Int          @default(0)
  completedAt         DateTime?
  
  user                User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  path                LearningPath @relation(fields: [pathId], references: [id], onDelete: Cascade)

  @@unique([userId, pathId])
  @@index([userId])
  @@index([pathId])
}

model ChatMessage {
  id          String   @id @default(uuid())
  userId      String
  projectId   String?
  role        String
  content     String
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project     Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([projectId])
  @@index([createdAt])
}

model Follow {
  id          String   @id @default(uuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())
  
  follower    User     @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)
  
  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

enum NotificationType {
  FOLLOW
  ACHIEVEMENT
  PROJECT_COMPLETE
  COMMENT
  UPVOTE
  TEAM_INVITE
  EVENT_REMINDER
  CHALLENGE_START
}

model Notification {
  id          String           @id @default(uuid())
  userId      String
  type        NotificationType
  title       String
  message     String
  link        String?
  read        Boolean          @default(false)
  createdAt   DateTime         @default(now())
  
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

enum EventStatus {
  UPCOMING
  ONGOING
  COMPLETED
}

model Event {
  id              String      @id @default(uuid())
  title           String
  description     String
  type            String
  startDate       DateTime
  endDate         DateTime
  status          EventStatus @default(UPCOMING)
  prizePool       String?
  maxParticipants Int?
  bannerUrl       String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  participants    EventParticipant[]
  leaderboard     EventLeaderboard[]
  
  @@index([status])
  @@index([startDate])
  @@index([type])
}

model EventParticipant {
  id          String   @id @default(uuid())
  eventId     String
  userId      String
  joinedAt    DateTime @default(now())
  
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

model EventLeaderboard {
  id          String   @id @default(uuid())
  eventId     String
  userId      String
  score       Int      @default(0)
  rank        Int?
  updatedAt   DateTime @updatedAt
  
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([eventId, userId])
  @@index([eventId, score])
  @@index([userId])
}

model SocialShare {
  id          String   @id @default(uuid())
  userId      String
  projectId   String
  platform    String
  shareUrl    String
  ogImageUrl  String?
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([projectId])
}

