// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

enum Role {
  STUDENT
  MENTOR
  ADMIN
  CONTRIBUTOR
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum DifficultyMode {
  GUIDED
  STANDARD
  HARDCORE
}

enum ProjectStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

model User {
  id              String         @id @default(uuid())
  email           String         @unique
  password        String?
  firstName       String
  lastName        String
  skillLevel      Difficulty     @default(BEGINNER)
  bio             String?
  portfolioLinks  String[]       @default([])
  xp              Int            @default(0)
  streak          Int            @default(0)
  role            Role           @default(STUDENT)
  avatarUrl       String?
  githubId        String?        @unique
  googleId        String?        @unique
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  projects        UserProject[]
  createdProjects Project[]      @relation("ProjectCreator")
  submissions     Submission[]
  comments        Comment[]
  votes           Vote[]
  forumThreads    ForumThread[]
  forumPosts      ForumPost[]
  
  teams           TeamMember[]
  achievements    UserAchievement[]
  pathProgress    UserPathProgress[]
  milestoneProgress UserMilestone[]
}

model Project {
  id               String            @id @default(uuid())
  title            String
  description      String
  difficultyLevel  Difficulty
  technologies     String[]
  categories       String[]
  estimatedTime    String?
  learningObjectives String[]
  resourceLinks    Json[]            @default([])
  starterRepoUrl   String?
  difficultyModes  DifficultyMode[]  @default([GUIDED, STANDARD, HARDCORE])
  submissionCount  Int               @default(0)
  completionRate   Float             @default(0)
  
  createdById      String
  createdBy        User              @relation("ProjectCreator", fields: [createdById], references: [id])
  
  milestones       ProjectMilestone[]
  userProjects     UserProject[]
  submissions      Submission[]
  forumThreads     ForumThread[]
  
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  teams           Team[]
  learningPaths   LearningPathProject[]
}

model UserProject {
  id                  String         @id @default(uuid())
  userId              String
  projectId           String
  status              ProjectStatus  @default(NOT_STARTED)
  difficultyModeChosen DifficultyMode
  repoUrl             String?
  startedAt           DateTime       @default(now())
  completedAt         DateTime?
  
  user                User           @relation(fields: [userId], references: [id])
  project             Project        @relation(fields: [projectId], references: [id])
  milestoneProgress   UserMilestone[]

  @@unique([userId, projectId, difficultyModeChosen])
}

model ProjectMilestone {
  id                String   @id @default(uuid())
  projectId         String
  milestoneNumber   Int
  title             String
  description       String
  hints             String[]
  validationCriteria String?
  
  project           Project  @relation(fields: [projectId], references: [id])
  userProgress      UserMilestone[]

  @@unique([projectId, milestoneNumber])
}

model UserMilestone {
  id              String           @id @default(uuid())
  userId          String
  userProjectId   String?          // Made optional for migration, but will be required
  milestoneId     String
  completedAt     DateTime         @default(now())
  
  user            User             @relation(fields: [userId], references: [id])
  userProject     UserProject?     @relation(fields: [userProjectId], references: [id])
  milestone       ProjectMilestone @relation(fields: [milestoneId], references: [id])

  @@unique([userId, milestoneId, userProjectId])
}

model Submission {
  id          String   @id @default(uuid())
  userId      String
  projectId   String
  repoUrl     String
  feedback    String?
  score       Int?
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id])
  project     Project  @relation(fields: [projectId], references: [id])
  comments    Comment[]
  votes       Vote[]
}

model Comment {
  id            String     @id @default(uuid())
  content       String
  userId        String
  submissionId  String
  createdAt     DateTime   @default(now())
  
  user          User       @relation(fields: [userId], references: [id])
  submission    Submission @relation(fields: [submissionId], references: [id])
}

model Vote {
  id            String     @id @default(uuid())
  value         Int        // 1 for upvote, -1 for downvote
  userId        String
  submissionId  String
  createdAt     DateTime   @default(now())
  
  user          User       @relation(fields: [userId], references: [id])
  submission    Submission @relation(fields: [submissionId], references: [id])

  @@unique([userId, submissionId])
}

model ForumThread {
  id            String     @id @default(uuid())
  title         String
  content       String
  userId        String
  projectId     String?    // Optional: project-specific thread
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  
  user          User       @relation(fields: [userId], references: [id])
  project       Project?   @relation(fields: [projectId], references: [id])
  posts         ForumPost[]
}

model ForumPost {
  id            String     @id @default(uuid())
  content       String
  userId        String
  threadId      String
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  
  user          User       @relation(fields: [userId], references: [id])
  thread        ForumThread @relation(fields: [threadId], references: [id])
}

model Team {
  id            String       @id @default(uuid())
  name          String
  projectId     String
  createdAt     DateTime     @default(now())
  
  project       Project      @relation(fields: [projectId], references: [id])
  members       TeamMember[]
}

model TeamMember {
  id            String   @id @default(uuid())
  teamId        String
  userId        String
  joinedAt      DateTime @default(now())
  
  team          Team     @relation(fields: [teamId], references: [id])
  user          User     @relation(fields: [userId], references: [id])

  @@unique([teamId, userId])
}

model Achievement {
  id          String   @id @default(uuid())
  name        String
  description String
  icon        String?
  xpReward    Int
  criteria    Json
  createdAt   DateTime @default(now())
  
  users       UserAchievement[]
}

model UserAchievement {
  id            String      @id @default(uuid())
  userId        String
  achievementId String
  earnedAt      DateTime    @default(now())
  
  user          User        @relation(fields: [userId], references: [id])
  achievement   Achievement @relation(fields: [achievementId], references: [id])

  @@unique([userId, achievementId])
}

model LearningPath {
  id          String   @id @default(uuid())
  name        String
  description String
  createdAt   DateTime @default(now())
  
  projects    LearningPathProject[]
  userProgress UserPathProgress[]
}

model LearningPathProject {
  id            String       @id @default(uuid())
  pathId        String
  projectId     String
  orderIndex    Int
  prerequisites String[]     @default([])
  
  path          LearningPath @relation(fields: [pathId], references: [id])
  project       Project      @relation(fields: [projectId], references: [id])

  @@unique([pathId, orderIndex])
}

model UserPathProgress {
  id                  String       @id @default(uuid())
  userId              String
  pathId              String
  currentProjectIndex Int          @default(0)
  completedAt         DateTime?
  
  user                User         @relation(fields: [userId], references: [id])
  path                LearningPath @relation(fields: [pathId], references: [id])

  @@unique([userId, pathId])
}

model ChatMessage {
  id          String   @id @default(uuid())
  userId      String
  projectId   String?
  role        String   // "user" or "assistant"
  content     String
  createdAt   DateTime @default(now())
}
